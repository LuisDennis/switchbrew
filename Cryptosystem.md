Like the 3DS, the Switch relies on a number of cryptographic keys to
prevent unauthorized persons from dumping and analyzing its software and
assets. This page will focus on the "symmetric" cryptography involved in
the Switch's cryptosystem.

## BootROM

The Switch's BootROM does no symmetric cryptographic operations.
However, it sets up two keys in the hardware security engine's keyslots:
the SBK (Secure Boot Key) in keyslot 0xE and the SSK (Secure Storage
Key) in keyslot 0xF. Reads from both of these keyslots are disabled by
the bootROM. The material used to generate these keys is stored in
special fuses that have their access disabled by the bootROM.

The SBK is common to all consoles while the SSK is console unique. The
SSK is not used on retail devices.

## Falcon coprocessor

The falcon processor (TSEC) stores a special console-unique key (that
will be referred to as the "device keyblob seed generation key") in
fuses that only microcode authenticated by NVidia has access
to.

## Bootloader stage 0

### Key generation

| Keyslot | Name              | Set by                             | Cleared by                         | Per-console |
| ------- | ----------------- | ---------------------------------- | ---------------------------------- | ----------- |
| 0xB     | Pk11DecryptionKey | [Package1](Package1.md "wikilink") | [Package1](Package1.md "wikilink") | No          |
| 0xC     | MasterKey         | [Package1](Package1.md "wikilink") | Forever                            | No          |
| 0xD     | ConsoleKey        | [Package1](Package1.md "wikilink") | Forever                            | Yes         |
| 0xE     | SecureBootKey     | Bootrom                            | [Package1](Package1.md "wikilink") | No          |
| 0xF     | SecureStorageKey  | Bootrom                            | [Package1](Package1.md "wikilink") | Yes         |

Bootloader stage 0 generates three keys. Keyslot 0xB is cleared after it
is used to decrypt the stage 2 bootloader; only keyslots 0xC and 0xD
will be transferred to stage 2. Additionally, keyslots 0xC and 0xD are
set read-only after they are generated. The SBK and the SSK are also
cleared after use (although the SSK isn't used at all, except on dev
units).

The master static key is generated by decrypting the master static seed
(a constant stored in bootloader .data) with the master static key
encryption key. The master static seed used varies depending on whether
the console is a retail unit or a dev unit. Both the master static key
encryption key and the stage 2 key are stored in a keyblob. The keyblob
format is described
[here](Flash%20Filesystem#Keyblob.md##Keyblob "wikilink").

The 32 blobs are stored in the eMMC. Only one at a time is loaded, it is
controlled by the bootloader version field in the BCT (at +0x2330).

Although the keydata is presumably common to all consoles, each keyblob
is console-unique, because the key used to encrypt it is at the factory
is console unique. Each keyblob has its own encryption key, with keyblob
key N generated by decrypting keyblob key seed N with the SBK, and
keyblob key seed N generated by decrypting keyblob N's seed constant
with the device keyblob seed generation key obtained from the Falcon.
Keyblob key 1 is special: In addition to being used to decrypt keyblob
1, it is also used to generate the master device key by decrypting a
constant block.

The key used to verify a keyblob's MAC is not the keyblob key but a key
derived from it; this is likely part of an attempt to mitigate
side-channel attacks as the MAC is an alterable part of the keyblob.

The bootloader only stores the seed constants for the keyblob loaded by
the current revision and for keyblob 1 (So that the master device key
can be generated).

This mechanism provides several advantages. If the stage 2 bootloader is
compromised, stage 1 can just use another master static key in the
keyblob. If stage 1 itself is glitched or exploited in such a way the
keyblob is dumped, Nintendo just has to change the loaded keyblob: the
vulnerable bootloader won't be able to decrypt the new keyblob, as the
keyblob key it knows is different from the one needed. Even if somehow
an exploit or glitch allowed one to be able to use the SBK to generate
keyblob keys, the seed constants for future keyblobs are unknown (and
will be until Nintendo releases new bootloaders that use them), and so
the exploit or glitch would have to be re-done on each new bootloader
revision (if it's not patched).

Dumping the fuses and TSEC key of any single system would effectively
bypass all of the above security mechanisms.

The key-derivation is described
[here](Package1#Key%20generation.md##Key_generation "wikilink").

#### Table of used keyblobs

| System version | Used keyblob | Used master static key encryption key in keyblob |
| -------------- | ------------ | ------------------------------------------------ |
| 1.0.0-2.3.0    | 1            | 1                                                |
| 3.0.0          | 2            | 1                                                |
| 3.0.1-3.0.2    | 3            | 1                                                |

## Bootloader stage 1

It is currently unknown what key generation the stage 2 bootloader does.

## Secure Monitor

The secure monitor performs some runtime cryptographic operations. See
[SMC](SMC.md "wikilink") for what operations it provides.
